<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Our Store - Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .product-card {
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            transition: transform 0.2s;
            height: 100%;
        }
        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .order-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: #f8f9fa;
        }
        .order-card:hover {
            background: #f1f3f4;
        }
        .price {
            font-size: 1.5rem;
            font-weight: bold;
            color: #28a745;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        .welcome-message {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        .status-badge {
            font-size: 0.8rem;
            padding: 4px 8px;
            border-radius: 12px;
        }
        .status-placed { background: #fff3cd; color: #856404; }
        .status-confirmed { background: #d1ecf1; color: #0c5460; }
        .status-shipped { background: #d4edda; color: #155724; }
        .status-delivered { background: #d1e7dd; color: #0f5132; }
        .status-cancelled { background: #f8d7da; color: #721c24; }
        .section-title {
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
            margin-bottom: 20px;
            color: #333;
        }
        /* Enhanced modal styles */
        .account-option {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .account-option:hover {
            border-color: #007bff;
            background-color: #f8f9fa;
        }

        .account-option.selected {
            border-color: #007bff;
            background-color: #e7f3ff;
        }

        .order-summary {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
}
    </style>
</head>
<body>
<!-- Header -->
<div class="header">
    <div class="container">
        <div class="row align-items-center">
            <div class="col">
                <h1 class="mb-2">Our Store Dashboard</h1>
                <p class="welcome-message mb-0" id="welcomeMessage">
                    Loading...
                </p>
            </div>
            <div class="col-auto">
                <div class="d-flex align-items-center">
                    <span class="me-3 user-email">Loading...</span>
                    <button id="logoutBtn" class="btn btn-light">
                        <i class="bi bi-box-arrow-right"></i> Logout
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Main Content -->
<div class="container">
    <div class="row">
        <!-- Products Section (Left Side) -->
        <div class="col-lg-8">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="section-title">Products</h3>
                <button class="btn btn-outline-primary btn-sm" onclick="loadProducts()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
            </div>
            <div id="productsContainer">
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading products...</span>
                    </div>
                    <p class="mt-2">Loading products...</p>
                </div>
            </div>
        </div>

        <!-- Orders Section (Right Side) -->
        <div class="col-lg-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="section-title">My Orders</h3>
                <button class="btn btn-outline-secondary btn-sm" onclick="loadOrders()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
            </div>
            <div id="ordersContainer">
                <div class="text-center">
                    <div class="spinner-border text-secondary" role="status">
                        <span class="visually-hidden">Loading orders...</span>
                    </div>
                    <p class="mt-2">Loading orders...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Purchase Modal with Bank Account Selection -->
<div class="modal fade" id="purchaseModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Purchase</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to purchase <strong id="productName"></strong>?</p>
                <p>Price: <strong id="productPrice"></strong></p>

                <div class="mb-3">
                    <label for="productQuantity" class="form-label">Quantity</label>
                    <input type="number" id="productQuantity" class="form-control" value="1" min="1">
                </div>

                <!-- Bank Account Reference Section -->
                <div class="mb-3">
                    <label class="form-label fw-bold">Payment Method</label>

                    <!-- Saved Account Option (shown if customer has saved account) -->
                    <div id="savedAccountSection" class="mb-3 p-3 border rounded" style="display: none;">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="accountOption"
                                   id="useSavedAccount" value="saved" checked>
                            <label class="form-check-label" for="useSavedAccount">
                                Use your saved account:
                                <span id="savedAccountRef" class="fw-bold text-success"></span>
                            </label>
                        </div>
                    </div>

                    <!-- New Account Option -->
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="accountOption"
                               id="useNewAccount" value="new">
                        <label class="form-check-label" for="useNewAccount">
                            Use a different account
                        </label>
                    </div>

                    <!-- New Account Input (hidden by default) -->
                    <div id="newAccountSection" style="display: none;">
                        <label for="bankAccountRef" class="form-label">Bank Account Reference</label>
                        <input type="text" id="bankAccountRef" class="form-control"
                               placeholder="Enter your bank account reference number">
                        <div class="form-text">
                            Enter your bank account reference for this payment.
                        </div>
                    </div>
                </div>

                <!-- Order Summary -->
                <div class="border-top pt-3 mt-3">
                    <h6>Order Summary</h6>
                    <div class="d-flex justify-content-between small">
                        <span>Subtotal:</span>
                        <span id="orderSubtotal">$0.00</span>
                    </div>
                    <div class="d-flex justify-content-between small">
                        <span>Shipping:</span>
                        <span id="orderShipping">$5.00</span>
                    </div>
                    <div class="d-flex justify-content-between small">
                        <span>Tax (10%):</span>
                        <span id="orderTax">$0.00</span>
                    </div>
                    <div class="d-flex justify-content-between fw-bold mt-1">
                        <span>Total:</span>
                        <span id="orderTotal">$0.00</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmPurchase">
                    <i class="bi bi-check-lg"></i> Confirm Purchase
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let currentProductId = null;
    let currentCustomer = null;
    let currentProductCode = null;
    let currentToken = null;

    // Check authentication and load data
    document.addEventListener('DOMContentLoaded', function() {
        const token = localStorage.getItem('jwtToken');
        currentToken = token;

        if (!token) {
            window.location.href = '/login';
            return;
        }

        console.log('JWT token found, loading dashboard...');
        loadCustomerData(token);
        loadProducts(token);
        loadOrders(token);
    });

    // Load products
    async function loadProducts(token = currentToken) {
        try {
            const response = await fetch('/api/products', {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                const products = await response.json();
                console.log('Products loaded:', products);
                renderProducts(products);
            } else {
                console.error('Failed to load products');
                showProductsError('Failed to load products');
            }
        } catch (error) {
            console.error('Error loading products:', error);
            showProductsError('Error loading products');
        }
    }

    // // Cancel order
    // function cancelOrder(orderId) {
    //     console.log('Cancelling order:', orderId);
    //     try {
    //         const response = await fetch(`/api/orders/{orderNumber}/cancel`, {
    //             method: 'DELETE',
    //             headers: {
    //                 'Authorization': 'Bearer ' + currentToken
    //             }
    //         });
    //     }
    //     catch (error) {
    //         console.error('Error cancelling order:', error);
    //         showOrdersError('Error cancelling order');
    //     }
    // }

    // Load orders
    async function loadOrders(token = currentToken) {
        try {
            const response = await fetch('/api/orders', {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                const orders = await response.json();
                console.log('Orders loaded:', orders);
                renderOrders(orders);
            } else {
                console.error('Failed to load orders');
                showOrdersError('Failed to load orders');
            }
        } catch (error) {
            console.error('Error loading orders:', error);
            showOrdersError('Error loading orders');
        }
    }

    function renderProducts(products) {
        const productsContainer = document.getElementById('productsContainer');

        if (!products || products.length === 0) {
            productsContainer.innerHTML = `
                <div class="row">
                    <div class="col-12 text-center">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> No products available at the moment.
                        </div>
                    </div>
                </div>
            `;
            return;
        }

        const productsHTML = products.map(product => `
            <div class="col-md-6 mb-4">
                <div class="product-card">
                    <h5>${escapeHtml(product.productName)}</h5>
                    <p class="text-muted small">${escapeHtml(product.description || 'No description available')}</p>
                    <div class="price">$${(product.price ).toFixed(2)}</div>
                    <button class="btn btn-primary mt-2 w-100"
                            data-product-id="${product.id}"
                            data-product-code="${product.productCode}"
                            onclick="purchaseProduct(this)">
                        <i class="bi bi-cart-plus"></i> Add to Cart
                    </button>
                </div>
            </div>
        `).join('');

        productsContainer.innerHTML = `
            <div class="row">
                ${productsHTML}
            </div>
        `;
    }

    function renderOrders(orders) {
        const ordersContainer = document.getElementById('ordersContainer');

        if (!orders || orders.length === 0) {
            ordersContainer.innerHTML = `
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> You haven't placed any orders yet.
                </div>
            `;
            return;
        }

        // Sort orders by date (newest first)
        orders.sort((a, b) => new Date(b.placedAt) - new Date(a.placedAt));

        const ordersHTML = orders.map(order => `
            <div class="order-card">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <strong class="text-truncate">${order.orderNumber}</strong>
                </div>
                <div class="mb-2">
                    <span class="status-badge status-${order.status.toLowerCase()}">
                        ${order.status}
                    </span>
                </div>
                <div class="small text-muted mb-2">
                    <i class="bi bi-calendar"></i> ${new Date(order.placedAt).toLocaleDateString()}
                </div>
                <div class="mb-2">
                    <strong>$${order.total.toFixed(2)}</strong>
                    <small class="text-muted">
                        (Items: $${order.subTotal.toFixed(2)} + Shipping: $${order.shipping.toFixed(2)})
                    </small>
                </div>
                <div class="small d-flex align-items-center justify-content-between gap-2">
                    <span class="text-truncate flex-grow-1">
                        <i class="bi bi-geo-alt"></i> ${escapeHtml(order.deliveryAddress.substring(0, 30))}${order.deliveryAddress.length > 30 ? '...' : ''}
                    </span>
                    <button class="btn btn-primary btn-sm flex-shrink-0" onclick="cancelOrder(${order.orderNumber})">
                        <i class="bi bi-x-circle"></i> Cancel
                    </button>
                </div>
                ${order.deliveryTrackingId ? `
                <div class="small mt-1">
                    <i class="bi bi-truck"></i> Tracking: ${order.deliveryTrackingId}
                </div>
                ` : ''}
            </div>
        `).join('');

        ordersContainer.innerHTML = ordersHTML;
    }

    async function loadCustomerData(token) {
        const userEmail = localStorage.getItem('userEmail');
        if (!userEmail) {
            updateUIWithFallbackData();
            return;
        }

        try {
            const response = await fetch(`/api/customers/by-email?email=${encodeURIComponent(userEmail)}`, {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                currentCustomer = await response.json();
                console.log('Customer data loaded:', currentCustomer);

                if (!currentCustomer.bankAccountRef) {
                    console.warn('Customer has no bankAccountRef, using default');
                    currentCustomer.bankAccountRef = 'DEFAULT_PAYMENT_REF';
                }

                updateUIWithCustomerData(currentCustomer);
            } else {
                console.error('Failed to load customer data');
                updateUIWithFallbackData();
            }
        } catch (error) {
            console.error('Error loading customer data:', error);
            updateUIWithFallbackData();
        }
    }

    function updateUIWithCustomerData(customer) {
        const welcomeElement = document.getElementById('welcomeMessage');
        if (welcomeElement && customer.firstName) {
            welcomeElement.innerHTML = `Welcome back, <strong>${escapeHtml(customer.firstName)}</strong>!`;
        } else if (welcomeElement) {
            welcomeElement.innerHTML = `Welcome back!`;
        }

        const userEmailElement = document.querySelector('.user-email');
        if (userEmailElement) {
            userEmailElement.textContent = customer.email;
        }
    }

    function updateUIWithFallbackData() {
        const userEmail = localStorage.getItem('userEmail');
        const welcomeElement = document.getElementById('welcomeMessage');
        const userEmailElement = document.querySelector('.user-email');

        if (welcomeElement) {
            welcomeElement.textContent = 'Discover amazing products';
        }
        if (userEmailElement && userEmail) {
            userEmailElement.textContent = userEmail;
        }
    }

    function showProductsError(message) {
        const productsContainer = document.getElementById('productsContainer');
        productsContainer.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i> ${message}
            </div>
        `;
    }

    function showOrdersError(message) {
        const ordersContainer = document.getElementById('ordersContainer');
        ordersContainer.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i> ${message}
            </div>
        `;
    }

    // Utility function to prevent XSS
    function escapeHtml(unsafe) {
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    // Purchase product function
    function purchaseProduct(button) {
        if (!currentCustomer) {
            alert('Please wait for customer data to load');
            return;
        }

        const productId = button.dataset.productId;
        const productCode = button.dataset.productCode;

        currentProductId = productId;
        currentProductCode = productCode;

        const productCard = button.closest('.product-card');
        const productName = productCard.querySelector('h5').textContent;
        const productPrice = productCard.querySelector('.price').textContent;

        document.getElementById('productName').textContent = productName;
        document.getElementById('productPrice').textContent = productPrice;

        const modal = new bootstrap.Modal(document.getElementById('purchaseModal'));
        modal.show();
    }

    // Confirm purchase
    document.getElementById('confirmPurchase').addEventListener('click', async function() {
        if (!currentProductId || !currentCustomer) {
            alert('Customer data not loaded. Please try again.');
            return;
        }

        const quantity = parseInt(document.getElementById('productQuantity').value || '1', 10);
        const token = localStorage.getItem('jwtToken');

        if (!token) {
            alert('Please login again');
            window.location.href = '/login';
            return;
        }

        const shippingFee = 5.00;
        const productPrice = parseFloat(document.getElementById('productPrice').textContent.replace('$',''));
        const subTotal = productPrice * quantity;
        const tax = subTotal * 0.1;
        const total = subTotal + shippingFee + tax;

        const orderPayload = {
            customerId: currentCustomer.id,
            customerEmail: currentCustomer.email,
            deliveryAddress: currentCustomer.address || 'Default Address',
            paymentAccountRef: currentCustomer.bankAccountRef || 'DEFAULT_PAYMENT_REF',
            shipping: shippingFee,
            tax: tax,
            subTotal: subTotal,
            total: total,
            status: 'PLACED',
            orderItems: [
                {
                    productId: currentProductId,
                    productCode: currentProductCode,
                    quantity: quantity,
                    price: productPrice
                }
            ]
        };

        console.log('Order payload:', orderPayload);

        try {
            const response = await fetch('/api/orders', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify(orderPayload)
            });

            if (response.ok) {
                alert('Purchase successful!');
                const modal = bootstrap.Modal.getInstance(document.getElementById('purchaseModal'));
                modal.hide();

                // Refresh orders to show the new order
                loadOrders(token);
            } else {
                const data = await response.json();
                console.error('Purchase failed:', data);
                alert('Purchase failed. Please try again.');
            }
        } catch (error) {
            console.error('Purchase error:', error);
            alert('Network error. Please try again.');
        }
    });

    // Logout functionality
    document.getElementById('logoutBtn').addEventListener('click', async function() {
        const token = localStorage.getItem('jwtToken');

        try {
            await fetch('/api/auth/logout', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            });
        } catch (error) {
            console.error('Logout API error:', error);
        } finally {
            localStorage.removeItem('jwtToken');
            localStorage.removeItem('userEmail');
            localStorage.removeItem('userRole');
            window.location.href = '/login';
        }
    });

    // Enhanced purchase product function
function purchaseProduct(button) {
    if (!currentCustomer) {
        alert('Please wait for customer data to load');
        return;
    }

    const productId = button.dataset.productId;
    const productCode = button.dataset.productCode;

    currentProductId = productId;
    currentProductCode = productCode;

    const productCard = button.closest('.product-card');
    const productName = productCard.querySelector('h5').textContent;
    const productPrice = productCard.querySelector('.price').textContent;

    document.getElementById('productName').textContent = productName;
    document.getElementById('productPrice').textContent = productPrice;

    // Setup bank account options
    setupBankAccountOptions();

    // Calculate initial order summary
    calculateOrderSummary();

    const modal = new bootstrap.Modal(document.getElementById('purchaseModal'));
    modal.show();
}

// Setup bank account options based on customer data
function setupBankAccountOptions() {
    const savedAccountSection = document.getElementById('savedAccountSection');
    const savedAccountRef = document.getElementById('savedAccountRef');
    const useSavedAccount = document.getElementById('useSavedAccount');
    const useNewAccount = document.getElementById('useNewAccount');
    const newAccountSection = document.getElementById('newAccountSection');
    const bankAccountRefInput = document.getElementById('bankAccountRef');

    // Reset form
    bankAccountRefInput.value = '';
    useSavedAccount.checked = true;
    newAccountSection.style.display = 'none';

    // Check if customer has a saved bank account
    if (currentCustomer && currentCustomer.bankAccountRef &&
        currentCustomer.bankAccountRef !== 'DEFAULT_PAYMENT_REF') {

        // Show saved account option
        savedAccountSection.style.display = 'block';
        savedAccountRef.textContent = currentCustomer.bankAccountRef;

        // Set up radio button event listeners
        useSavedAccount.addEventListener('change', function() {
            if (this.checked) {
                newAccountSection.style.display = 'none';
                bankAccountRefInput.removeAttribute('required');
            }
        });

        useNewAccount.addEventListener('change', function() {
            if (this.checked) {
                newAccountSection.style.display = 'block';
                bankAccountRefInput.setAttribute('required', 'required');
                bankAccountRefInput.focus();
            }
        });

    } else {
        // No saved account - show only new account input
        savedAccountSection.style.display = 'none';
        useNewAccount.checked = true;
        newAccountSection.style.display = 'block';
        bankAccountRefInput.setAttribute('required', 'required');
    }
}

// Calculate and update order summary
function calculateOrderSummary() {
    const quantity = parseInt(document.getElementById('productQuantity').value || '1', 10);
    const productPrice = parseFloat(document.getElementById('productPrice').textContent.replace('$', ''));

    const shippingFee = 5.00;
    const subTotal = productPrice * quantity;
    const tax = subTotal * 0.1;
    const total = subTotal + shippingFee + tax;

    document.getElementById('orderSubtotal').textContent = `$${subTotal.toFixed(2)}`;
    document.getElementById('orderShipping').textContent = `$${shippingFee.toFixed(2)}`;
    document.getElementById('orderTax').textContent = `$${tax.toFixed(2)}`;
    document.getElementById('orderTotal').textContent = `$${total.toFixed(2)}`;
}

// Get selected bank account reference
function getSelectedBankAccountRef() {
    const useSavedAccount = document.getElementById('useSavedAccount');
    const bankAccountRefInput = document.getElementById('bankAccountRef');

    if (useSavedAccount.checked) {
        return currentCustomer.bankAccountRef;
    } else {
        return bankAccountRefInput.value.trim();
    }
}

// Validate bank account reference
function validateBankAccountRef(accountRef) {
    if (!accountRef || accountRef.trim() === '') {
        alert('Please enter a bank account reference');
        return false;
    }

    if (accountRef.length < 5) {
        alert('Bank account reference must be at least 5 characters long');
        return false;
    }

    return true;
}

// Update the confirm purchase event listener
document.getElementById('confirmPurchase').addEventListener('click', async function() {
    if (!currentProductId || !currentCustomer) {
        alert('Customer data not loaded. Please try again.');
        return;
    }

    const quantity = parseInt(document.getElementById('productQuantity').value || '1', 10);
    const token = localStorage.getItem('jwtToken');
    const bankAccountRef = getSelectedBankAccountRef();

    // Validate bank account reference
    if (!validateBankAccountRef(bankAccountRef)) {
        return;
    }

    if (!token) {
        alert('Please login again');
        window.location.href = '/login';
        return;
    }

    const shippingFee = 5.00;
    const productPrice = parseFloat(document.getElementById('productPrice').textContent.replace('$', ''));
    const subTotal = productPrice * quantity;
    const tax = subTotal * 0.1;
    const total = subTotal + shippingFee + tax;

    const orderPayload = {
        customerId: currentCustomer.id,
        customerEmail: currentCustomer.email,
        deliveryAddress: currentCustomer.address || 'Default Address',
        paymentAccountRef: bankAccountRef,
        shipping: shippingFee,
        tax: tax,
        subTotal: subTotal,
        total: total,
        status: 'PLACED',
        orderItems: [
            {
                productId: currentProductId,
                productCode: currentProductCode,
                quantity: quantity,
                price: productPrice
            }
        ]
    };

    console.log('Order payload:', orderPayload);

    try {
        const response = await fetch('/api/orders', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify(orderPayload)
        });

        if (response.ok) {
            alert('Purchase successful!');
            const modal = bootstrap.Modal.getInstance(document.getElementById('purchaseModal'));
            modal.hide();

            // Refresh orders to show the new order
            loadOrders(token);
        } else {
            const data = await response.json();
            console.error('Purchase failed:', data);
            alert('Purchase failed. Please try again.');
        }
    } catch (error) {
        console.error('Purchase error:', error);
        alert('Network error. Please try again.');
    }
});

// Add event listener for quantity changes to update order summary
document.getElementById('productQuantity').addEventListener('input', calculateOrderSummary);

// Add event listener for modal show to reset form
document.getElementById('purchaseModal').addEventListener('show.bs.modal', function() {
    document.getElementById('productQuantity').value = '1';
    calculateOrderSummary();
});
</script>
</body>
</html>