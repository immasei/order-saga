
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Email Inbox</title>
  <style>
    body { font-family: -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
    .row { display: flex; gap: 8px; align-items: center; margin-bottom: 12px; }
    input[type="email"] { padding: 8px; width: 320px; }
    button { padding: 8px 12px; cursor: pointer; }
    #messages { display: flex; flex-direction: column-reverse; gap: 10px; }
    .msg { border: 1px solid #ddd; border-radius: 8px; padding: 10px; }
    .sub { font-weight: 600; margin-bottom: 6px; }
    .meta { color: #666; font-size: 12px; margin-top: 6px; }
  </style>
  <script defer src="/app.js"></script>
  <script>
    window.addEventListener('DOMContentLoaded', () => {
      const params = new URLSearchParams(location.search);
      const to = params.get('to');
      if (to) document.getElementById('to').value = to;
    });
  </script>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
</head>
<body>
  <h2>Email Inbox</h2>
  <div class="row">
    <label for="to">To:</label>
    <input id="to" type="email" placeholder="demo@customer.local" />

    <button id="load">Load</button>
  </div>
  <div id="messages"></div>
</body>
<script>
  (() => {
    const toInput = document.getElementById('to');
    const loadBtn = document.getElementById('load');
    const container = document.getElementById('messages');
    let es = null;
    const renderedIds = new Set();

    function render(list) {
      container.innerHTML = '';
      renderedIds.clear();
      list.sort((a, b) => new Date(b.sentAt || b.createdAt || 0) - new Date(a.sentAt || a.createdAt || 0));
      list.forEach(addCard);
    }

    function addCard(m) {
      if (!m || !m.id) return;
      if (renderedIds.has(m.id)) return;
      const div = document.createElement('div');
      div.className = 'msg';

      div.innerHTML = `
      <div class="sub">${escapeHtml(m.subject)}</div>
      <div>${escapeHtml(m.body)}</div>
      <div class="meta">
        to: ${escapeHtml(m.toAddress)} |
        status: ${m.status} |
        id: ${m.id} |
        ${m.sentAt ? 'sent: ' + new Date(m.sentAt).toLocaleString() : ''}
      </div>
    `;

      container.prepend(div);
      renderedIds.add(m.id);
    }

    function escapeHtml(s) {
      return (s || '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
    }

    async function load() {
      const to = toInput.value.trim();
      const url = to ? `/api/emails?to=${encodeURIComponent(to)}` : '/api/emails';

      const res = await fetch(url, { cache: 'no-store' });
      const data = await res.json();
      render(data);
      startStream();
    }

    function startStream() {
      if (es) { try { es.close(); } catch {} es = null; }
      const to = toInput.value.trim();
      const url = to ? `/api/emails/stream?to=${encodeURIComponent(to)}` : '/api/emails/stream';
      es = new EventSource(url);
      es.onmessage = (e) => {
        try { addCard(JSON.parse(e.data)); } catch {}
      };
    }

    loadBtn.addEventListener('click', load);

    // auto-load on first open for convenience
    document.addEventListener('DOMContentLoaded', load);
  })();
</script>
</html>

